// Generated by: hibernate/SpringHibernateDaoImpl.vsl in andromda-spring-cartridge.
// license-header java merge-point
/**
 * This is only generated once! It will never be overwritten.
 * You can (and have to!) safely modify it by hand.
 */
package org.phoenixctms.ctsms.domain;

import java.util.Collection;
import java.util.HashMap;

import org.hibernate.Criteria;
import org.hibernate.criterion.CriteriaSpecification;
import org.hibernate.criterion.DetachedCriteria;
import org.hibernate.criterion.Order;
import org.hibernate.criterion.Projections;
import org.hibernate.criterion.Restrictions;
import org.hibernate.criterion.Subqueries;
import org.phoenixctms.ctsms.query.CriteriaUtil;
import org.phoenixctms.ctsms.query.SubCriteriaMap;
import org.phoenixctms.ctsms.vo.PSFVO;
import org.phoenixctms.ctsms.vo.ProbandGroupOutVO;
import org.phoenixctms.ctsms.vo.ProbandListEntryInVO;
import org.phoenixctms.ctsms.vo.ProbandListEntryOutVO;
import org.phoenixctms.ctsms.vo.ProbandOutVO;
import org.phoenixctms.ctsms.vo.TrialOutVO;
import org.phoenixctms.ctsms.vo.UserOutVO;
import org.phoenixctms.ctsms.vocycle.ProbandListEntryGraph;

/**
 * @see ProbandListEntry
 */
public class ProbandListEntryDaoImpl
extends ProbandListEntryDaoBase
{

	private org.hibernate.Criteria createListEntryCriteria() {
		org.hibernate.Criteria listEntryCriteria = this.getSession().createCriteria(ProbandListEntry.class);
		return listEntryCriteria;
	}

	@Override
	protected Collection<ProbandListEntry> handleFindByTrialGroupProbandCountPerson(
			Long trialId, Long probandGroupId, Long probandId, boolean total,
			Boolean person, PSFVO psf) throws Exception {
		org.hibernate.Criteria listEntryCriteria = createListEntryCriteria();
		SubCriteriaMap criteriaMap = new SubCriteriaMap(ProbandListEntry.class, listEntryCriteria);
		if (trialId != null) {
			listEntryCriteria.add(Restrictions.eq("trial.id", trialId.longValue()));
		}
		if (probandGroupId != null) {
			listEntryCriteria.add(Restrictions.eq("group.id", probandGroupId.longValue()));
		}
		if (probandId != null || person != null) {
			Criteria probandCriteria = criteriaMap.createCriteria("proband", CriteriaSpecification.INNER_JOIN);
			// Criteria probandCriteria = listEntryCriteria.createCriteria("proband", CriteriaSpecification.INNER_JOIN); //org.hibernate.QueryException: duplicate association path:
			// proband
			if (probandId != null) {
				probandCriteria.add(Restrictions.idEq(probandId.longValue()));
			}
			if (person != null) {
				probandCriteria.add(Restrictions.eq("person", person.booleanValue()));
			}
			// listEntryCriteria.add(Restrictions.eq("proband.id", probandId.longValue()));
		}
		if (!total) {
			criteriaMap.createCriteria("lastStatus.status", CriteriaSpecification.INNER_JOIN).add(Restrictions.eq("count", true));
			// listEntryCriteria.createCriteria("lastStatus", CriteriaSpecification.INNER_JOIN).createCriteria("status", CriteriaSpecification.INNER_JOIN)
			// .add(Restrictions.eq("count", true));
			// istEntryCriteria.add(Restrictions.eq("proband.id", probandId.longValue()));
		}
		CriteriaUtil.applyPSFVO(criteriaMap, psf);
		return listEntryCriteria.list();
	}



	@Override
	protected Collection<ProbandListEntry> handleFindByTrialPosition(
			Long trialId, Long position) throws Exception {
		org.hibernate.Criteria listEntryCriteria = createListEntryCriteria();
		if (trialId != null) {
			listEntryCriteria.add(Restrictions.eq("trial.id", trialId.longValue()));
		}
		if (position != null) {
			listEntryCriteria.add(Restrictions.eq("position", position.longValue()));
		}
		return listEntryCriteria.list();
	}

	@Override
	protected ProbandListEntry handleFindByTrialProband(
			Long trialId, Long probandId) throws Exception {
		org.hibernate.Criteria listEntryCriteria = createListEntryCriteria();
		listEntryCriteria.add(Restrictions.eq("trial.id", trialId.longValue()));
		listEntryCriteria.add(Restrictions.eq("proband.id", probandId.longValue()));
		listEntryCriteria.setMaxResults(1);
		return (ProbandListEntry) listEntryCriteria.uniqueResult();
		// Iterator<ProbandListEntry> it = listEntryCriteria.list().iterator();
		// if (it.hasNext()) {
		// return it.next();
		// }
		// return null;
	}

	@Override
	protected Collection<ProbandListEntry> handleFindByTrialProbandSorted(Long trialId, Long probandId)
			throws Exception {
		org.hibernate.Criteria listEntryCriteria = createListEntryCriteria();
		if (trialId != null) {
			listEntryCriteria.add(Restrictions.eq("trial.id", trialId.longValue()));
		}
		if (probandId != null) {
			listEntryCriteria.add(Restrictions.eq("proband.id", probandId.longValue()));
		}
		listEntryCriteria.addOrder(Order.asc("trial"));
		listEntryCriteria.addOrder(Order.asc("position"));
		return listEntryCriteria.list();
	}

	@Override
	protected Long handleFindMaxPosition(Long trialId) throws Exception {
		org.hibernate.Criteria listEntryCriteria = createListEntryCriteria();
		if (trialId != null) {
			listEntryCriteria.add(Restrictions.eq("trial.id", trialId.longValue()));
		}
		listEntryCriteria.setProjection(Projections.max("position"));
		return (Long) listEntryCriteria.uniqueResult();
	}

	@Override
	protected Collection<ProbandListEntry> handleGetProbandList(
			Long trialId, org.phoenixctms.ctsms.enumeration.ProbandListStatusLogLevel logLevel, boolean last)
					throws Exception {
		// http://stackoverflow.com/questions/1648426/hibernate-detached-queries-as-a-part-of-the-criteria-query
		// https://forum.hibernate.org/viewtopic.php?p=2317841#2317841
		org.hibernate.Criteria listEntryCriteria = createListEntryCriteria();
		if (trialId != null) {
			listEntryCriteria.add(Restrictions.eq("trial.id", trialId.longValue()));
		}
		if (logLevel != null) {
			org.hibernate.Criteria statusEntryCriteria;
			if (last) {
				statusEntryCriteria = listEntryCriteria.createCriteria("statusEntries", "probandListStatusEntry0", CriteriaSpecification.INNER_JOIN);
			} else {
				statusEntryCriteria = listEntryCriteria.createCriteria("statusEntries", CriteriaSpecification.INNER_JOIN);
			}
			org.hibernate.Criteria statusTypeCriteria = statusEntryCriteria.createCriteria("status", CriteriaSpecification.INNER_JOIN);
			org.hibernate.Criteria logLevelCriteria = statusTypeCriteria.createCriteria("logLevels", CriteriaSpecification.INNER_JOIN);
			logLevelCriteria.add(Restrictions.eq("logLevel", logLevel));
			if (last) {
				DetachedCriteria subQuery = DetachedCriteria.forClass(ProbandListStatusEntryImpl.class, "probandListStatusEntry1"); // IMPL!!!!
				subQuery.add(Restrictions.eqProperty("probandListStatusEntry1.listEntry", "probandListStatusEntry0.listEntry"));
				subQuery.setProjection(Projections.max("id"));
				statusEntryCriteria.add(Subqueries.propertyEq("id", subQuery));
			} else {
				listEntryCriteria.setResultTransformer(org.hibernate.Criteria.DISTINCT_ROOT_ENTITY);
			}
		}
		listEntryCriteria.addOrder(Order.asc("trial"));
		listEntryCriteria.addOrder(Order.asc("position"));
		return listEntryCriteria.list();
	}

	@Override
	protected long handleGetTrialGroupProbandCount(
			Long trialId, Long probandGroupId, Long probandId, boolean total) throws Exception {
		org.hibernate.Criteria listEntryCriteria = createListEntryCriteria();
		if (trialId != null) {
			listEntryCriteria.add(Restrictions.eq("trial.id", trialId.longValue()));
		}
		if (probandGroupId != null) {
			listEntryCriteria.add(Restrictions.eq("group.id", probandGroupId.longValue()));
		}
		if (probandId != null) {
			listEntryCriteria.add(Restrictions.eq("proband.id", probandId.longValue()));
		}
		if (!total) {
			listEntryCriteria.createCriteria("lastStatus", CriteriaSpecification.INNER_JOIN).createCriteria("status", CriteriaSpecification.INNER_JOIN)
			.add(Restrictions.eq("count", true));
			// istEntryCriteria.add(Restrictions.eq("proband.id", probandId.longValue()));
		}
		return (Long) listEntryCriteria.setProjection(Projections.rowCount()).uniqueResult();
	}

	/**
	 * Retrieves the entity object that is associated with the specified value object
	 * from the object store. If no such entity object exists in the object store,
	 * a new, blank entity is created
	 */
	private ProbandListEntry loadProbandListEntryFromProbandListEntryInVO(ProbandListEntryInVO probandListEntryInVO)
	{
		// TODO implement loadProbandListEntryFromProbandListEntryInVO
		// throw new UnsupportedOperationException("org.phoenixctms.ctsms.domain.loadProbandListEntryFromProbandListEntryInVO(ProbandListEntryInVO) not yet implemented.");
		ProbandListEntry probandListEntry = null;
		Long id = probandListEntryInVO.getId();
		if (id != null) {
			probandListEntry = this.load(id);
		}
		if (probandListEntry == null)
		{
			probandListEntry = ProbandListEntry.Factory.newInstance();
		}
		return probandListEntry;
	}

	/**
	 * Retrieves the entity object that is associated with the specified value object
	 * from the object store. If no such entity object exists in the object store,
	 * a new, blank entity is created
	 */
	private ProbandListEntry loadProbandListEntryFromProbandListEntryOutVO(ProbandListEntryOutVO probandListEntryOutVO)
	{
		// TODO implement loadProbandListEntryFromProbandListOutVO
		// throw new UnsupportedOperationException("org.phoenixctms.ctsms.domain.loadProbandListEntryFromProbandListOutVO(ProbandListOutVO) not yet implemented.");
		throw new UnsupportedOperationException("out value object to recursive entity not supported");
		// ProbandListEntry probandListEntry = this.load(probandListEntryOutVO.getId());
		// if (probandListEntry == null)
		// {
		// probandListEntry = ProbandListEntry.Factory.newInstance();
		// }
		// return probandListEntry;
	}

	/**
	 * @inheritDoc
	 */
	@Override
	public ProbandListEntry probandListEntryInVOToEntity(ProbandListEntryInVO probandListEntryInVO)
	{
		ProbandListEntry entity = this.loadProbandListEntryFromProbandListEntryInVO(probandListEntryInVO);
		this.probandListEntryInVOToEntity(probandListEntryInVO, entity, true);
		return entity;
	}

	/**
	 * @inheritDoc
	 */
	@Override
	public void probandListEntryInVOToEntity(
			ProbandListEntryInVO source,
			ProbandListEntry target,
			boolean copyIfNull)
	{
		super.probandListEntryInVOToEntity(source, target, copyIfNull);
		Long trialId = source.getTrialId();
		Long probandId = source.getProbandId();
		Long groupId = source.getGroupId();
		if (trialId != null) {
			Trial trial = this.getTrialDao().load(trialId);
			target.setTrial(trial);
			trial.addProbandListEntries(target);
		} else if (copyIfNull) {
			Trial trial = target.getTrial();
			target.setTrial(null);
			if (trial != null) {
				trial.removeProbandListEntries(target);
			}
		}
		if (probandId != null) {
			Proband proband = this.getProbandDao().load(probandId);
			target.setProband(proband);
			proband.addTrialParticipations(target);
		} else if (copyIfNull) {
			Proband proband = target.getProband();
			target.setProband(null);
			if (proband != null) {
				proband.removeTrialParticipations(target);
			}
		}
		if (groupId != null) {
			ProbandGroup group = this.getProbandGroupDao().load(groupId);
			target.setGroup(group);
			group.addProbandListEntries(target);
		} else if (copyIfNull) {
			ProbandGroup group = target.getGroup();
			target.setGroup(null);
			if (group != null) {
				group.removeProbandListEntries(target);
			}
		}
	}

	/**
	 * @inheritDoc
	 */
	@Override
	public ProbandListEntry probandListEntryOutVOToEntity(ProbandListEntryOutVO probandListEntryOutVO)
	{
		ProbandListEntry entity = this.loadProbandListEntryFromProbandListEntryOutVO(probandListEntryOutVO);
		this.probandListEntryOutVOToEntity(probandListEntryOutVO, entity, true);
		return entity;
	}

	/**
	 * @inheritDoc
	 */
	@Override
	public void probandListEntryOutVOToEntity(
			ProbandListEntryOutVO source,
			ProbandListEntry target,
			boolean copyIfNull)
	{
		super.probandListEntryOutVOToEntity(source, target, copyIfNull);
		TrialOutVO trialVO = source.getTrial();
		ProbandOutVO probandVO = source.getProband();
		ProbandGroupOutVO groupVO = source.getGroup();
		UserOutVO modifiedUserVO = source.getModifiedUser();
		if (trialVO != null) {
			Trial trial = this.getTrialDao().trialOutVOToEntity(trialVO);
			target.setTrial(trial);
			trial.addProbandListEntries(target);
		} else if (copyIfNull) {
			Trial trial = target.getTrial();
			target.setTrial(null);
			if (trial != null) {
				trial.removeProbandListEntries(target);
			}
		}
		if (probandVO != null) {
			Proband proband = this.getProbandDao().probandOutVOToEntity(probandVO);
			target.setProband(proband);
			proband.addTrialParticipations(target);
		} else if (copyIfNull) {
			Proband proband = target.getProband();
			target.setProband(null);
			if (proband != null) {
				proband.removeTrialParticipations(target);
			}
		}
		if (groupVO != null) {
			ProbandGroup group = this.getProbandGroupDao().probandGroupOutVOToEntity(groupVO);
			target.setGroup(group);
			group.addProbandListEntries(target);
		} else if (copyIfNull) {
			ProbandGroup group = target.getGroup();
			target.setGroup(null);
			if (group != null) {
				group.removeProbandListEntries(target);
			}
		}
		if (modifiedUserVO != null) {
			target.setModifiedUser(this.getUserDao().userOutVOToEntity(modifiedUserVO));
		} else if (copyIfNull) {
			target.setModifiedUser(null);
		}
	}

	/**
	 * @inheritDoc
	 */
	@Override
	public ProbandListEntryInVO toProbandListEntryInVO(final ProbandListEntry entity)
	{
		return super.toProbandListEntryInVO(entity);
	}

	/**
	 * @inheritDoc
	 */
	@Override
	public void toProbandListEntryInVO(
			ProbandListEntry source,
			ProbandListEntryInVO target)
	{
		super.toProbandListEntryInVO(source, target);
		Trial trial = source.getTrial();
		Proband proband = source.getProband();
		ProbandGroup group = source.getGroup();
		if (trial != null) {
			target.setTrialId(trial.getId());
		}
		if (proband != null) {
			target.setProbandId(proband.getId());
		}
		if (group != null) {
			target.setGroupId(group.getId());
		}
	}

	/**
	 * @inheritDoc
	 */
	@Override
	public ProbandListEntryOutVO toProbandListEntryOutVO(final ProbandListEntry entity)
	{
		return super.toProbandListEntryOutVO(entity);
	}

	/**
	 * @inheritDoc
	 */
	@Override
	public void toProbandListEntryOutVO(
			ProbandListEntry source,
			ProbandListEntryOutVO target)
	{
		(new ProbandListEntryGraph(this, this.getProbandListStatusEntryDao(), this.getTrialDao(), this.getProbandDao(), this.getProbandGroupDao(), this.getUserDao())).toVOHelper(
				source, target, new HashMap<Class, HashMap<Long, Object>>());
	}

	@Override
	public void toProbandListEntryOutVO(
			ProbandListEntry source,
			ProbandListEntryOutVO target, HashMap<Class, HashMap<Long, Object>> voMap)
	{
		(new ProbandListEntryGraph(this, this.getProbandListStatusEntryDao(), this.getTrialDao(), this.getProbandDao(), this.getProbandGroupDao(), this.getUserDao())).toVOHelper(
				source, target, voMap);
	}
}